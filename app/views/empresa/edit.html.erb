<!-- BEGIN PAGE CONTAINER -->
<div class="page-container" ng-view ng-controller="EmpresaCtrl" ng-cloak="">
	<!-- BEGIN PAGE HEAD -->
	<div class="page-head">
			<!-- END PAGE TITLE -->
			<!-- BEGIN PAGE CONTENT -->
		<div class="page-content">
			<div class="container">
				<!-- BEGIN PAGE BREADCRUMB -->
				<ul class="page-breadcrumb breadcrumb">
					<li>
						 <%= link_to "Pagina Inicial", root_path, 'data-no-turbolink' => true %>
					</li>
					<i class="fa fa-circle"></i>
					<li>
						<%= link_to "Empresas", empresas_path, 'data-no-turbolink' => true%>
					</li>
					<i class="fa fa-circle"></i>
					<li class="active">
						<%= t"#{action_name}" %>
					</li>
				</ul>

				<div class="col-md-12">			 
					<div class="profile-content">
						<div class="row">
						<form ng-submit="save()" id="form">	
							<div class="col-md-12">
								<div class="portlet light">
								 <div class="portlet-title tabbable-line">
										<div class="caption caption-md">
											<i class="icon-globe theme-font hide"></i>
												<span class="caption-subject font-blue-madison bold uppercase"><%= t"#{action_name}" %> Empresa</span>
											<i class="fa fa-pencil"></i>
										</div>
										<div class="actions btn-set">									
											<%= link_to '<i class="fa fa-angle-left"></i> Voltar'.html_safe,empresas_path, :type => "button",:name => "back",
											:class => "btn btn-default btn-circle", 'data-no-turbolink' => true %>													
											<button ng-click="save()" class="btn btn-default btn-circle"><i class="fa fa-check"></i> Salvar</button>
										</div>											 
									</div>
									<div class="portlet-body" id="form-portlet">
										<div ng-if="mensagens.length > 0" id="error_explanation" class="Metronic-alerts alert alert-danger">
											<ul ng-repeat="msg in mensagens">												
						 						<li>{{msg}}</li>													
											</ul>
										</div>
										<ul class="nav nav-tabs">
										 	<li class="active">
												<a ncheck="true" href="#tab_1_1" data-toggle="tab">Informações Gerais</a>
											</li>
											<li>
												<a ncheck="true" href="#tab_1_0" data-toggle="tab">Endereço</a>
											</li>
											<% if current_user.user_type != 2%>
												<li ng-if="empresa.id != null">
													<a ncheck="true" href="#tab_1_2" data-toggle="tab">Usuários</a>
												</li>
												<li>
													<a ncheck="true" href="#tab_1_3" data-toggle="tab">Certificados Digitais</a>
												</li>
											<%end%>
											<li>
												<a ncheck="true" href="#tab_1_4" data-toggle="tab">Fiscal</a>
											</li>
										</ul>
										<div class="tab-content">
											<div class="tab-pane active" id="tab_1_1">
												<div class="form-group">
													<!--ie8, ie9 does not support html5 placeholder, so we just show field title for that-->
													<label class="control-label ">Razao Social</label>
													<input type="text" name="razao_social" ng-model='empresa.razao_social' class='form-control placeholder-no-fix'></input>														
												</div>

												<div class="form-group">
													<!--ie8, ie9 does not support html5 placeholder, so we just show field title for that-->
													<label class="control-label ">Nome Fantasia</label>
													<input type="text" name="nome_fantasia" ng-model='empresa.nome_fantasia' class='form-control placeholder-no-fix'></input>														
												</div>

												<div class='row'>
													<div class='col-md-4'>
														<div class="form-group">
															<!--ie8, ie9 does not support html5 placeholder, so we just show field title for that-->
															<label class="control-label ">CNPJ</label>
															<input type="text" name="cnpj" ui-br-cnpj-mask ng-model='empresa.cnpj' class='form-control placeholder-no-fix'></input>
														</div>
													</div>
													<div class='col-md-4'>
														<div class="form-group">
															<!--ie8, ie9 does not support html5 placeholder, so we just show field title for that-->
															<label class="control-label ">Inscrição Estadual</label>
															<input type="text" name="insc_estadual" ng-model='empresa.insc_estadual' class='form-control placeholder-no-fix'></input>																
														</div>
													</div>
													<div class='col-md-4'>
														<div class="form-group">
															<!--ie8, ie9 does not support html5 placeholder, so we just show field title for that-->
															<label class="control-label ">Inscrição Municipal</label>
															<input type="text" name="insc_municipal" ng-model='empresa.insc_municipal' class='form-control placeholder-no-fix'></input>																
														</div>
													</div>
												</div>
												<div class='row'>
													<div class='col-md-4'>
														<div class="form-group">
															<!--ie8, ie9 does not support html5 placeholder, so we just show field title for that-->
															<label class="control-label ">Empresa enquadrada no SUPERSIMPLES</label>
															<input type="checkbox" name="eess" ng-model='empresa.supersimples' class='form-control placeholder-no-fix'></input>
														</div>
													</div>
												</div>
											</div>
											<div class="tab-pane" id="tab_1_0" >								
												<div class="form-body" id="form-endereco">
													<div class="row">
														<div class="col-md-12 ">
															<div class="form-group">
																<label>Rua</label>
																<input type="text" name="rua" ng-model='empresa.rua' class='form-control placeholder-no-fix'></input>																	
															</div>
														</div>
													</div>
													<div class="row">
														<div class="col-md-6">
															<div class="form-group">
																<label>Numero</label>
																<input type="text" name="num_rua" ng-model='empresa.num_rua' class='form-control placeholder-no-fix'></input>																	
															</div>
														</div>
														<!--/span-->
														<div class="col-md-6">
															<div class="form-group">
																<label>Complemento</label>
																<input type="text" name="complemento" ng-model='empresa.complemento' class='form-control placeholder-no-fix'></input>																	
															</div>
														</div>
														<!--/span-->
													</div>
													<!--/row-->
													<div class="row">
														<div class="col-md-6">
															<div class="form-group">
																<label>Bairro</label>
																<input type="text" name="bairro" ng-model='empresa.bairro' class='form-control placeholder-no-fix'></input>																	
															</div>
														</div>
														<!--/span-->
														
														<div class="col-md-6">
															<div class="form-group">
																<label>CEP</label>
																<input type="text" name="cep" ng-model='empresa.cep' ui-br-cep-mask ng-blur="findCep()" class='form-control placeholder-no-fix'></input>																	
															</div>
														</div>
														<div class="col-md-6">
															<div class="form-group">
																<label>Cidade</label>
																<input type="text" name="cidade" ng-model='empresa.cidade' class='form-control placeholder-no-fix'></input>																	
															</div>
														</div>
														<!--/span-->
														<div class="col-md-6">
															<div class="form-group">
																<label>UF</label>
																<select name="uf" class="form-control" ng-model="empresa.uf"
																	ng-options="value.uf as value.descricao for (key,value) in estados">				
															</select>
															</div>
														</div>
													</div>
												</div>								
											</div>
											<% if current_user.user_type != 2%>
												<div class="tab-pane" id="tab_1_2" ng-if="empresa.id != null">								
													<table class="table table-striped table-bordered table-hover" id="SimpleTable" >
														<thead>
															<tr>
																<th class="" style="width: 24px;">			
																	<input type="checkbox" class="group-checkable" data-set="#SimpleTable .checkboxes"/>
																</th>
																<th>
																	Nome
																</th>
																<th>
																	Email
																</th>																					
															</tr>
														</thead>
														<tbody>
															<tr class="odd gradeX" ng-repeat="item in userTable">
																<td>
																	<input ng-if="containsEmpresa(item) == 'true'" ng-click="changeUserTable($event)" type="checkbox" lass="checkboxes" checked="true" value= "{{item.id}}"/>
																	<input ng-if="containsEmpresa(item) == 'false'" ng-click="changeUserTable($event)" type="checkbox" class="checkboxes" value= "{{item.id}}"/>
																</td>
																<td>
																	{{item.fullname}}																		
																</td>
																<td>
																	{{item.email}}																			
																</td>																							
															</tr>																
														</tbody>
													</table><br>								
												</div>
												<div class="tab-pane" id="tab_1_3">
													<div class="row">
														<div class="col-md-12 col-sm-12">
															<div class="portlet light bordered">
																<div class="portlet-title">	
																	<div class="caption font-grey-gallery">
																		<span class="caption-subject bold uppercase">Certificado</span>
																	</div>																
																	<div class="actions">
																		<a href="#modalCD" data-toggle="modal" ncheck="true" ng-click="cleanCertificado()" class="btn btn-default btn-sm">
																		<i class="fa fa-plus"></i> Novo </a>
																	</div>
																</div>
																<div class="portlet-body">
																	<div class="table-responsive">
																		<table ng-if="certificadodigitals.length > 0" class="table table-hover table-bordered table-striped">
																			<thead>
																					<tr>
																					<th>Requerente</th>
																					<th>Válido a partir de</th>
																					<th>Válido até</th>
																					<th>Vigente</th>
																					<th>Excluir</th>
																				</tr>
																			</thead>
																			<tbody>
																				<tr ng-repeat="cd in certificadodigitals">
																					<td>{{cd.requerente}}</td>
																					<td>{{cd.inicio | date: "dd/MM/yyyy"}}</td>
																					<td>{{cd.fim | date: "dd/MM/yyyy"}}</td>									
																					<td ng-if="isValidoCD(cd.fim) == 'true'">
																						<span class="glyphicon glyphicon-ok font-green"/>
																					</td>
																					<td ng-if="isValidoCD(cd.fim) == 'false'">
																						<span class="glyphicon glyphicon-remove font-red"/>
																					</td>
																					<td><a ng-click="deleteCertificado($index)" class="btn red-thunderbird btn-xs">Deletar</a></td>
																				</tr>															
																			</tbody>
																		</table>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</div>
												<div class="tab-pane" id="tab_1_4">
										 			<div class="row">
														<div class="col-md-6">
															<div class="panel panel-default">
																<div class="panel-heading">
																	<h3 class="panel-title">PIS/COFINS</h3>
																</div>
																<div class="panel-body">													
														 			<div class="row">
														 				<div class="col-md-6">
														 					<div class="form-group">
														 						<label class="control-label">Alíquota (PIS)</label>
														 						<div class="input-group">
																					<input type="number" ng-model="empresa.aliquotapis" class="form-control placeholder-no-fix"> </input>
																					<span class="input-group-addon">%</span>
																				</div>
														 					</div>
														 				</div>
														 				<div class="col-md-6">
														 					<div class="form-group">
														 						<label class="control-label">Alíquota (COFINS)</label>
														 						<div class="input-group">
																					<input type="number" ng-model="empresa.aliquotaconfins" class="form-control placeholder-no-fix"> </input>
																					<span class="input-group-addon">%</span>
																				</div>
														 					</div>
														 				</div>
														 			</div>										 			
																</div>
															</div>
														</div>
													</div>
												</div>
											<%end%>	
										</div>
									</div>
								</div>
							</div>
						</form>	
						</div>
					</div> 
				</div>
			</div>
		</div>
		<!-- END PAGE CONTENT -->
	</div>

<div class="modal fade" id="modalCD" tabindex="-1" role="basic" aria-hidden="true" >
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">				
				<h4 class="modal-title">Certificado Digital</h4>
			</div>
			<div class="modal-body">
				<div ng-if="mensagensCD.length > 0" id="error_explanation" class="Metronic-alerts alert alert-danger">
					<ul ng-repeat="msg in mensagensCD">												
				 		<li>{{msg}}</li>													
					</ul>
				</div>
				<form id="form-modal">
				<div class="form-group">
        			<label class="control-label">Selecione o certificado</label>
        			<input id="arquivoCD" ng-model="arquivoCD" type="file" class="form-control placeholder-no-fix">
    			</div>
    			<div class="form-group">
        			<label class="control-label">Senha</label>
        			<input id="senhaCD" ng-model="senhaCD" type="password" class="form-control placeholder-no-fix">
    			</div>
    			</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn default" data-dismiss="modal">Voltar</button>				
				<button ng-click="saveCertificado()" type="button" class="btn blue">Salvar</button>
			</div>
		</div>
	</div>		
</div>

</div>  

<script>
myApp.controller('EmpresaCtrl', ['$scope', function($scope){
	angular.element(document).ready(function () {
		//$('[name="cnpj"]').mask("99.999.999/9999-99");	
		//$('[name="cep"]').mask("99.999-999");		
	});	
	$scope.mensagens = [];
	$scope.mensagensCD = [];
	$scope.empresa = <%= @empresa.to_json.html_safe=%>;	
	$scope.estados = <%= @estados.to_json.html_safe=%>;
	$scope.userTable = <%=@userTable.html_safe=%>;
	$scope.certificadodigitals = <%=@certificadodigitals.to_json.html_safe=%>;
	$scope.arquivoCD = '';

	$scope.isValidoCD = function(fim){
		if(fim > new Date()){
			return "true";
		}else{
			return "false";
		}
	}			

	$scope.containsEmpresa = function(user)
	{

		for(var index = 0; index < user.empresas.length; index++)
		{	
			if(user.empresas[index].id == $scope.empresa.id)
			{
				return 'true'; 
			}
		}
		return 'false';
	}

	$scope.findCep = function(){
		$scope.empresa.cep = $('[name="cep"]').mask();				
		Metronic.blockUI({
			target: '#form-endereco',
			animate: true
		});
		if($scope.empresa.cep.length == 8){
			$.ajax({
				url: "//viacep.com.br/ws/"+ $scope.empresa.cep +"/json/?callback=?",
				dataType: 'json',
				async: false,
				success: function(dados){
					$scope.empresa.rua = dados.logradouro;
					$scope.empresa.bairro = dados.bairro;
					$scope.empresa.cidade = dados.localidade;
					$scope.empresa.uf = dados.uf;
					$('[name="cep"]').mask("99.999-999");
					Metronic.unblockUI('#form-endereco');
					$('[name="rua"]').focus();

				},
				error: function(jqXHR, textStatus, errorThrown){
					bootbox.alert("CEP não encontrado.");
					Metronic.unblockUI('#form-endereco');
				}

			});			
		}else{
			bootbox.alert("CEP inválido");
			Metronic.unblockUI('#form-endereco');
		}
	}

	$scope.changeUserTable = function(event){		
		var checkedObj = $("#SimpleTable input:checkbox:checked").map(function(){ return $(this).val();}).get(); 
	    
	    if(checkedObj[0] == "on")
	    {
		    checkedObj.shift()
		}		
		$.ajax({
			type: 'post',
			url: '/empresas/checked_rows',
			data: {users : checkedObj}
		});
	}

	$("#arquivoCD").on('change', function(event) {		
		var files = event.target.files;
		var image = files[0];
		var reader = new FileReader();
		reader.onload = function(file){			
			$scope.arquivoCD = file.target.result;			
		}
		reader.readAsDataURL(image);
	});

	$scope.cleanCertificado = function(){
		$("#form-modal")[0].reset();
		$scope.mensagensCD = [];
	}

	$scope.deleteCertificado = function(index){
		$scope.certificadodigitals.splice(index,1);
	}

	$scope.saveCertificado = function(){				
		$.ajax({
			async: false,
			method: 'post',
			url: '/empresas/saveCertificado/',
			data: {empresa_id: $scope.empresa.id, arquivo: $scope.arquivoCD, senha: $scope.senhaCD},
			success: function (data){	
				var confirm = true;
				if(data.cnpj != $scope.empresa.cnpj){
					if(!window.confirm("O certificado possui cnpj diferente da empresa cadastrada. Tem certeza que quer salvar mesmo assim?")){
						confirm = false;
					}
				}							
				if(confirm){
					$scope.certificadodigitals.push(data);								
					$("#modalCD").modal("toggle");
				}				
			},
			error: function (jqXHR, textStatus, errorThrown){
				$scope.mensagensCD = JSON.parse(jqXHR.responseText);
			}
		});

	}

	$scope.save = function()
	{			
		$('[name="cnpj"]').unmask();
		$('[name="cep"]').unmask();		

		$.ajax({
			async: false,
      		method: 'post',
      		url: '/empresas/save/',
      		data: { empresa: $scope.empresa, certificadodigitals: JSON.stringify($scope.certificadodigitals)},
      		success: function (data)
      		{       			   			     			      			
      			window.location.replace('<%=empresas_path=%>');
      		},
      		error: function (jqXHR, textStatus, errorThrown)
      		{       			   			      			     			  			     			
      			$scope.mensagens = JSON.parse(jqXHR.responseText);      			
      		}
   	 	});   	 
	}	
}]);
</script>
